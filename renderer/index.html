<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>Workroom</title>
    <style>
      body {
        margin: 0;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
        background: #f7f7f7;
        height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .card {
        text-align: center;
        padding: 28px;
        width: 360px;
      }
      h1 { margin: 0 0 10px 0; font-size: 22px; font-weight: 600; }
      p { margin: 0 0 18px 0; color: #444; }
      .row { display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; }
      button {
        padding: 12px 14px;
        font-size: 14px;
        border: 1px solid #ccc;
        background: #fff;
        cursor: pointer;
        border-radius: 10px;
        min-width: 90px;
      }
      #timer {
        margin-top: 20px;
        font-size: 56px;
        font-weight: 650;
        letter-spacing: 1px;
        display: none;
      }
      #hint {
        margin-top: 10px;
        color: #666;
        display: none;
      }
      #quit {
        margin-top: 22px;
        color: #888;
        font-size: 12px;
        cursor: pointer;
      }
      #end {
        display: none;
        margin-top: 18px;
      }
      #end p {
        margin: 0 0 12px 0;
        color: #444;
      }
    </style>
  </head>

  <body>
    <div class="card">
      <h1>Workroom</h1>
      <p id="subtitle">Choose your focus duration.</p>

      <div class="row" id="choices">
        <button data-min="15">15 min</button>
        <button data-min="30">30 min</button>
        <button data-min="60">60 min</button>
      </div>

      <div id="timer">00:00</div>
      <div id="hint">Work until the room opens.</div>

      <div id="end">
        <p>Session complete.</p>
        <div class="row">
          <button data-break="5">Break 5</button>
          <button data-break="10">Break 10</button>
        </div>
        <div class="row" style="margin-top:10px;">
          <button data-round="15">Another 15</button>
          <button data-round="30">Another 30</button>
          <button data-round="60">Another 60</button>
        </div>
      </div>

      <div id="quit" title="Dev escape">Quit (dev)</div>
    </div>

    <script>
      console.log('[RENDERER] loaded');

      const choices = document.getElementById('choices');
      const timerEl = document.getElementById('timer');
      const hintEl = document.getElementById('hint');
      const quitEl = document.getElementById('quit');
      const endEl = document.getElementById('end');
      const subtitleEl = document.getElementById('subtitle');

      let intervalId = null;
      let secondsLeft = 0;
      let mode = 'idle'; // idle | focus | break | done

      function stopTimer() {
        if (intervalId) clearInterval(intervalId);
        intervalId = null;
      }

      function renderTime() {
        const m = Math.floor(secondsLeft / 60);
        const s = secondsLeft % 60;
        timerEl.textContent = `${m}:${String(s).padStart(2, '0')}`;
      }

      function showChoices() {
        choices.style.display = 'flex';
        timerEl.style.display = 'none';
        hintEl.style.display = 'none';
        endEl.style.display = 'none';
        subtitleEl.textContent = 'Choose your focus duration.';
        mode = 'idle';
      }

      function showCountdown() {
        choices.style.display = 'none';
        endEl.style.display = 'none';
        timerEl.style.display = 'block';
        hintEl.style.display = 'block';
        subtitleEl.textContent = ' ';
      }

      function showEnd() {
        hintEl.style.display = 'none';
        endEl.style.display = 'block';
        subtitleEl.textContent = ' ';
        mode = 'done';
      }

      function startCountdown(minutes, nextMode) {
        stopTimer();
        mode = nextMode;
        secondsLeft = minutes * 60;
        renderTime();
        showCountdown();

        intervalId = setInterval(() => {
          secondsLeft--;
          renderTime();

          if (secondsLeft <= 0) {
            stopTimer();

            if (mode === 'break') {
              showChoices();
              return;
            }

            showEnd();
          }
        }, 1000);
      }

      function startFocus(minutes) {
        startCountdown(minutes, 'focus');
      }

      function startBreak(minutes) {
        subtitleEl.textContent = 'Break.';
        startCountdown(minutes, 'break');
      }

      choices.addEventListener('click', (e) => {
        const btn = e.target.closest('button');
        if (!btn) return;
        startFocus(Number(btn.dataset.min));
      });

      endEl.addEventListener('click', (e) => {
        const b = e.target.closest('button');
        if (!b) return;

        if (b.dataset.break) startBreak(Number(b.dataset.break));
        if (b.dataset.round) startFocus(Number(b.dataset.round));
      });

      // Dev escape (renderer side): Esc closes the window (works only while framed/allowed)
      window.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') window.close();
      });

      quitEl.addEventListener('click', () => window.close());
    </script>
  </body>
</html>
